!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const o of e)if("childList"===o.type)for(const e of o.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();class e{constructor(e){if(!e)throw new Error("API密钥不能为空");this.apiKey=e,this.baseUrl="https://api.kie.ai/api/v1",this.defaultTimeout=3e4,this.pollInterval=1e3}async request(e,t={}){const o=`${this.baseUrl}${e}`,n={Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json",...t.headers},s={...t,headers:n};try{const e=await fetch(o,s);if(!e.ok){const t=await e.json().catch(()=>({}));throw new Error(t.msg||`HTTP ${e.status}: ${e.statusText}`)}return await e.json()}catch(r){if("TypeError"===r.name)throw new Error("网络错误，请检查网络连接");throw r}}async createTask(e,t={}){if(!e||"string"!=typeof e)throw new Error("提示词不能为空");const o={model:"nano-banana-pro",input:{prompt:e.trim(),image_input:[],aspect_ratio:t.aspectRatio||"3:4",resolution:t.resolution||"4K",output_format:t.outputFormat||"png"}};if(o.input.prompt.length>1e4)throw new Error("提示词长度不能超过10000字符");console.log("API Request Parameters:"),console.log("  Model:",o.model),console.log("  Aspect Ratio:",o.input.aspect_ratio),console.log("  Resolution:",o.input.resolution),console.log("  Output Format:",o.input.output_format),console.log("  Prompt Length:",o.input.prompt.length),console.log("  Full Prompt:",o.input.prompt);const n=await this.request("/jobs/createTask",{method:"POST",body:JSON.stringify(o)});if(200!==n.code)throw new Error(n.msg||"创建任务失败");if(!n.data||!n.data.taskId)throw new Error("API返回数据格式错误");return{taskId:n.data.taskId,prompt:o.input.prompt,options:o.input}}async getTaskStatus(e){if(!e)throw new Error("任务ID不能为空");const t=await this.request(`/jobs/recordInfo?taskId=${e}`,{method:"GET"});if(200!==t.code)throw new Error(t.msg||"查询任务状态失败");return t.data}async waitForTask(e,t={}){const o=t.timeout||this.defaultTimeout,n=t.interval||this.pollInterval,s=Date.now();for(t.onProgress&&t.onProgress(0,"开始生成...");Date.now()-s<o;)try{const o=await this.getTaskStatus(e);let s=0,r="准备中...";switch(o.state){case"waiting":s=10,r="排队中，请稍候...";break;case"processing":s=50,r="AI正在绘画中...";break;case"success":return s=100,r="生成完成！",{success:!0,data:o,progress:100};case"fail":throw s=100,r="生成失败",new Error(o.failMsg||"任务执行失败");default:s=20,r="处理中..."}t.onProgress&&t.onProgress(s,r),"waiting"!==o.state&&"processing"!==o.state||await new Promise(e=>setTimeout(e,n))}catch(r){throw r}throw new Error(`任务超时（${o/1e3}秒）`)}async generate(e,t={}){try{t.onProgress&&t.onProgress(10,"提交生成任务...");const n=await this.createTask(e,t),s=await this.waitForTask(n.taskId,{timeout:t.timeout,interval:t.pollInterval,onProgress:t.onProgress});let r=null;try{const e=JSON.parse(s.data.resultJson);if(r=e.resultUrls&&e.resultUrls[0],!r)throw new Error("未找到图片URL")}catch(o){throw new Error("解析结果失败")}return{success:!0,imageUrl:r,taskId:n.taskId,prompt:n.prompt,data:s.data}}catch(o){return{success:!1,error:o.message}}}}class t{constructor(){this.template=this.loadTemplate(),this.titleTemplates=null,this.loadTitleTemplates()}async loadTitleTemplates(){try{const e=await fetch("./titles.json"),t=await e.json();this.titleTemplates=t.titleTemplates}catch(e){console.error("Failed to load title templates:",e),this.titleTemplates={defaultTitle:"英语学习小报"}}}loadTemplate(){return'Comic poster: Generate an English learning poster for teenagers titled "{{themeScene}}/{{title}}", vertical A4 layout, educational newspaper style, suitable for 10-16 year olds learning English through pictures.\n\n# I. Title Section (Top)\n\n**Large centered title**: "{{title}}"\n* **Style**: Educational newspaper / English learning poster\n* **Text requirements**: Large, bold, cartoon handwritten font, colorful gradient outlines (using rainbow colors: red, orange, yellow, green, blue, purple)\n* **Decorations**: Add {{themeScene}}/{{title}}-related colorful sticker-style decorations around the title, bright and eye-catching\n\n# II. Main Scene (Center)\n\nThe center features a **cartoon illustration of a "{{themeScene}}/{{title}}" scene**:\n* **Overall atmosphere**: Bright, warm, positive, engaging\n* **Composition**: Clear object boundaries for easy text association, not overcrowded\n\n**Scene zones and core content**:\n1. **Core Zone A (Main activities)**: Show key {{themeScene}}/{{title}} activities\n2. **Core Zone B (Tools & items)**: Display related equipment and objects\n3. **Core Zone C (Environment)**: Show environmental features (walls, signs, etc.)\n\n**Main character**:\n* **Character**: 1 cute cartoon character (profession/identity matching {{themeScene}}/{{title}})\n* **Action**: Naturally interacting with the scene\n\n# III. Required Objects & Vocabulary List\n\n**Must clearly draw the following objects and leave space for labels**:\n\n**1. Core characters & facilities**:\n{{coreObjects}}\n\n**2. Common items/tools**:\n{{commonItems}}\n\n**3. Environment & decorations**:\n{{environmentItems}}\n\n*(Note: The number of objects in the image is not limited to this, but the above list must be the main focus)*\n\n# IV. Labeling Rules\n\nFor each object above, attach educational labels with:\n* **Format**: Three-line style (Line 1: English word, Line 2: Chinese characters, Line 3: phonetic symbols)\n* **Style**: Colorful sticker style, each label with different vibrant background colors (pink, light blue, light green, yellow, orange), dark text for high contrast\n* **Typography**: Fun, playful fonts suitable for children, rounded letters\n* **Layout**: Labels positioned near corresponding objects without obscuring the main illustration\n\n# V. Art Style Parameters\n* **Style**: Children\'s picture book + educational poster\n* **Color palette**: High saturation, bright, warm tones with rainbow accents (High Saturation, Warm Tone)\n* **Text treatment**: All text elements should be colorful with gradient effects, shadows, or outlines to make them pop\n* **Quality**: 8k resolution, high detail, vector illustration style, clean lines, professional printing quality'}async generatePrompt(e={}){if(!e.theme||!e.theme.name)throw new Error("主题信息不能为空");if(!e.vocabulary||!Array.isArray(e.vocabulary))throw new Error("词汇列表不能为空");const t=e.theme,o=e.scene||t.scenes[0],n=e.vocabulary,s=e.customTitle||"";let r;this.titleTemplates||await this.loadTitleTemplates(),r=s&&s.trim()?s.trim():this.getTitle(t,o);const a=e=>{let t=e.phonetic||"";return t&&!t.startsWith("/")&&(t=`/${t}`),t&&!t.endsWith("/")&&(t=`${t}/`),`${e.english} ${t} ${e.chinese}`},i=n.filter(e=>"character"===e.category).slice(0,5).map(a).join(", "),l=n.filter(e=>"object"===e.category).slice(0,8).map(a).join(", "),c=n.filter(e=>"environment"===e.category).slice(0,5).map(a).join(", "),d=`${o.name}`;return this.template.replace(/{{title}}/g,r).replace(/{{themeScene}}/g,d).replace(/{{coreObjects}}/g,i).replace(/{{commonItems}}/g,l).replace(/{{environmentItems}}/g,c)}getTitle(e,t){if(!this.titleTemplates)return t?`${e.name}-${t.name}`:e.name;const o=e.id,n=null==t?void 0:t.id;if(this.titleTemplates[o]&&this.titleTemplates[o][n]){const e=this.titleTemplates[o][n];return e[Math.floor(Math.random()*e.length)]}return this.titleTemplates.defaultTitle||"英语学习小报"}}class o{constructor(){let e=localStorage.getItem("apiKey")||"";if(!e)try{const t=localStorage.getItem("bulletin-store");if(t){const o=JSON.parse(t);o.settings&&o.settings.apiKey&&(e=o.settings.apiKey,localStorage.setItem("apiKey",e))}}catch(o){console.error("从 bulletin-store 加载 API key 失败:",o)}let t={};try{const e=localStorage.getItem("settings");e&&(t={...t,...JSON.parse(e)})}catch(o){console.error("加载设置失败:",o)}this.state={currentSection:"welcome",currentTheme:null,currentScene:null,selectedVocabulary:[],maxVocabulary:20,generationStatus:"idle",customTitle:"",aspectRatio:"4:5",resolution:"2K",apiKey:e,settings:t},this.listeners=[]}setState(e){this.state={...this.state,...e},this.notifyListeners(),this.saveToStorage()}subscribe(e){this.listeners.push(e)}notifyListeners(){this.listeners.forEach(e=>{try{e(this.state)}catch(t){console.error("State listener error:",t)}})}saveToStorage(){this.state.apiKey&&localStorage.setItem("apiKey",this.state.apiKey),localStorage.setItem("settings",JSON.stringify(this.state.settings));try{const e={gallery:this.state.gallery||[],settings:{...this.state.settings,apiKey:this.state.apiKey}};localStorage.setItem("bulletin-store",JSON.stringify(e))}catch(e){console.error("保存到 bulletin-store 失败:",e)}}selectTheme(e){const t=e.scenes[0]||null;this.setState({currentTheme:e,currentScene:t,selectedVocabulary:this.getInitialVocabulary(e,t),customTitle:""})}getInitialVocabulary(e,t=null){if(!e)return[];const o=t||e.scenes[0];return o&&o.vocabulary?o.vocabulary.slice(0,20):[]}selectAllVocabulary(){const{currentScene:e}=this.state;e&&e.vocabulary&&this.setState({selectedVocabulary:[...e.vocabulary].slice(0,this.state.maxVocabulary)})}clearAllVocabulary(){this.setState({selectedVocabulary:[]})}toggleVocabulary(e){const{selectedVocabulary:t}=this.state,o=t.findIndex(t=>t.english===e.english);if(o>-1){const e=[...t];e.splice(o,1),this.setState({selectedVocabulary:e})}else t.length<this.state.maxVocabulary&&this.setState({selectedVocabulary:[...t,e]})}}class n{constructor(e,t){this.container=e,this.store=t,this.currentScene=null,this.init()}init(){this.render(),this.bindEvents(),this.updateSelectedCount()}render(){if(!this.currentScene||!this.currentScene.vocabulary||0===this.currentScene.vocabulary.length)return void(this.container.innerHTML='<p class="no-vocabulary">该场景暂无词汇数据</p>');const e=this.groupVocabularyByCategory(this.currentScene.vocabulary),t={character:"人物角色",object:"物品工具",environment:"环境设施",action:"动作行为"},o=Object.entries(e).map(([e,o])=>`\n            <div class="vocabulary-category" data-category="${e}">\n                <h4>${t[e]||e}</h4>\n                <div class="word-grid">\n                    ${o.map(e=>this.renderWordItem(e)).join("")}\n                </div>\n            </div>\n        `).join("");this.container.innerHTML=o}renderWordItem(e){const t=this.isWordSelected(e),o=e.category||"object";return`\n            <div class="word-item ${t?"selected":""}"\n                 data-word="${e.english}"\n                 data-category="${o}">\n                <div class="word-content">\n                    <div class="word-english">${e.english}</div>\n                    <div class="word-phonetic">/${e.phonetic}/</div>\n                    <div class="word-chinese">${e.chinese}</div>\n                </div>\n                <button class="toggle-btn">${t?"✓":"+"}</button>\n            </div>\n        `}groupVocabularyByCategory(e){const t={character:[],object:[],environment:[],action:[]};return e.forEach(e=>{t.hasOwnProperty(e.category)?t[e.category].push(e):t.object.push(e)}),t}bindEvents(){this.container.addEventListener("click",e=>{const t=e.target.closest(".word-item");t&&this.handleWordClick(t)})}handleWordClick(e){const t={english:e.dataset.word,phonetic:e.querySelector(".word-phonetic").textContent.replace(/[\/\\]/g,""),chinese:e.querySelector(".word-chinese").textContent,category:e.dataset.category};this.store.toggleVocabulary(t),this.updateWordItem(e,t),this.updateSelectedCount()}updateWordItem(e,t){const o=this.isWordSelected(t),n=e.querySelector(".toggle-btn");o?(e.classList.add("selected"),n.textContent="✓"):(e.classList.remove("selected"),n.textContent="+")}isWordSelected(e){return this.store.state.selectedVocabulary.some(t=>t.english===e.english)}updateSelectedCount(){const e=this.store.state.selectedVocabulary.length,t=document.getElementById("selectedCount");t&&(t.textContent=e)}setScene(e){this.currentScene=e,this.render(),this.bindEvents(),this.updateSelectedCount()}updateUI(){this.container.querySelectorAll(".word-item").forEach(e=>{const t={english:e.dataset.word,phonetic:e.querySelector(".word-phonetic").textContent.replace(/[\/\\]/g,""),chinese:e.querySelector(".word-chinese").textContent,category:e.dataset.category};this.updateWordItem(e,t)}),this.updateSelectedCount()}}class s{constructor(e){this.store=e,this.vocabularyEditor=null,this.progressInterval=null,this.lastProgress=0,this.init()}init(){this.setupEventListeners(),this.setupModalListeners(),this.loadSettings()}setupEventListeners(){const e=document.getElementById("startBtn");e&&e.addEventListener("click",async()=>await this.showSection("welcomeSection"));const t=document.getElementById("backToTheme");t&&t.addEventListener("click",async()=>await this.showSection("welcomeSection"));const o=document.getElementById("selectAllBtn"),n=document.getElementById("clearAllBtn");o&&o.addEventListener("click",()=>{this.store.selectAllVocabulary(),this.showToast(`已选择 ${this.store.state.selectedVocabulary.length} 个词汇`)}),n&&n.addEventListener("click",()=>{this.store.clearAllVocabulary(),this.showToast("已清空所有选择")});const s=document.getElementById("settingsBtn");s&&s.addEventListener("click",()=>this.showModal("settingsModal")),document.addEventListener("click",e=>{const t=e.target.closest(".theme-card");t&&this.handleThemeSelection(t)});const r=document.getElementById("customTitle"),a=document.getElementById("aspectRatio"),i=document.getElementById("resolution");r&&r.addEventListener("input",e=>{this.store.setState({customTitle:e.target.value})}),a&&a.addEventListener("change",e=>{this.store.setState({aspectRatio:e.target.value})}),i&&i.addEventListener("change",e=>{this.store.setState({resolution:e.target.value})}),document.addEventListener("click",e=>{e.target&&"generateBtn"===e.target.id&&(console.log("Generate button clicked via delegation!"),console.log("Current section before generation:",this.store.state.currentSection),e.preventDefault(),e.stopPropagation(),this.handleGeneration())})}setupModalListeners(){const e=document.getElementById("closeSettingsBtn"),t=document.getElementById("saveSettingsBtn"),o=document.getElementById("cancelSettingsBtn");e&&e.addEventListener("click",()=>this.hideModal("settingsModal")),t&&t.addEventListener("click",()=>this.saveSettings()),o&&o.addEventListener("click",()=>this.hideModal("settingsModal"));const n=document.getElementById("cancelGenerationBtn");n&&n.addEventListener("click",()=>{console.log("Cancel generation clicked");const e=document.getElementById("generationModal");e&&(e.classList.add("hidden"),document.body.classList.remove("modal-open")),this.store.setState({generationStatus:"idle"})}),document.addEventListener("click",e=>{e.target.classList.contains("modal-overlay")&&this.hideModal(e.target.id)})}async showSection(e){document.querySelectorAll(".content-section").forEach(e=>{e.classList.add("hidden")});const t=document.getElementById(e);t&&t.classList.remove("hidden"),this.store.setState({currentSection:e}),"contentConfig"===e?(this.updateThemeDisplay(),this.initializeVocabularyEditor()):"welcomeSection"===e&&await r()}async handleThemeSelection(e){const t=e.dataset.themeId,o=window.themes.find(e=>e.id===t);o&&(this.store.selectTheme(o),await this.showSection("contentConfig"),this.showToast(`已选择主题：${o.name}`))}updateThemeDisplay(){const{currentTheme:e,currentScene:o}=this.store.state;if(!e)return;const n=document.getElementById("selectedThemeIcon"),s=document.getElementById("selectedThemeName"),r=document.getElementById("selectedSceneName"),a=document.getElementById("defaultTitleDisplay");if(n&&(n.textContent=e.icon),s&&(s.textContent=e.name),r&&(r.textContent=`场景：${o?o.name:"未知"}`),a){const n=new t;if(n.titleTemplates){const t=n.getTitle(e,o);a.innerHTML=t}else a.innerHTML="加载中...",n.loadTitleTemplates().then(()=>{const t=n.getTitle(e,o);a.innerHTML=t})}}initializeVocabularyEditor(){const e=document.querySelector(".vocabulary-categories");e&&!this.vocabularyEditor?(this.vocabularyEditor=new n(e.parentElement,this.store),this.vocabularyEditor.setScene(this.store.state.currentScene)):this.vocabularyEditor&&this.vocabularyEditor.setScene(this.store.state.currentScene)}showModal(e){const t=document.getElementById(e);if(t){const o=window.scrollX||window.pageXOffset,n=window.scrollY||window.pageYOffset;document.body.setAttribute("data-scroll-x",o),document.body.setAttribute("data-scroll-y",n),t.classList.remove("hidden"),t.style.transform=`translate(0, ${n}px)`,t.style.transition="transform 0s",document.body.classList.add("modal-open"),document.body.style.position="fixed",document.body.style.top=`-${n}px`,document.body.style.left=`-${o}px`,document.body.style.width="100vw",document.body.style.overflow="hidden",console.log(`Modal ${e} displayed successfully`),setTimeout(()=>{const t=document.getElementById(e);if(t&&!t.classList.contains("hidden")){const e=t.getBoundingClientRect(),o=window.innerHeight,n=window.innerWidth;(e.bottom<0||e.top>o||e.right<0||e.left>n)&&(console.warn("模态框在视口外，应用修复措施"),t.classList.add("modal-force-viewport-fix"))}},50)}else console.error(`Modal with id ${e} not found`)}hideModal(e){const t=document.getElementById(e);t&&(t.classList.add("hidden"),t.style.transform="",t.style.transition="",t.classList.remove("modal-force-viewport-fix"));const o=parseInt(document.body.getAttribute("data-scroll-y")||"0",10),n=parseInt(document.body.getAttribute("data-scroll-x")||"0",10);document.body.classList.remove("modal-open"),document.body.style.position="",document.body.style.top="",document.body.style.left="",document.body.style.width="",document.body.style.overflow="",document.body.removeAttribute("data-scroll-x"),document.body.removeAttribute("data-scroll-y"),window.scrollTo(n,o)}showToast(e,t=3e3){const o=document.getElementById("toast");o&&(o.textContent=e,o.classList.remove("hidden"),setTimeout(()=>{o.classList.add("hidden")},t))}saveSettings(e=!1){const t=document.getElementById("apiKey").value;t?localStorage.setItem("apiKey",t):localStorage.removeItem("apiKey");try{const e=localStorage.getItem("bulletin-store"),o=e?JSON.parse(e):{settings:{}};o.settings.apiKey=t,localStorage.setItem("bulletin-store",JSON.stringify(o))}catch(o){console.error("保存 API key 到 bulletin-store 失败:",o)}this.store.setState({apiKey:t}),e||(this.hideModal("settingsModal"),this.showToast("设置已保存"))}loadSettings(){const e=localStorage.getItem("apiKey")||this.store.state.apiKey,t=document.getElementById("apiKey");t&&(t.value=e||"")}async showResult(e){await this.showSection("resultDisplay"),document.body.classList.add("result-visible");const t=document.getElementById("imageStatusBadge"),o=document.getElementById("statusText");document.getElementById("statusIcon");const n=document.getElementById("generatedImage"),s=document.getElementById("resultVocabularyGrid"),r=document.querySelector(".result-header h2"),a=document.querySelector(".result-subtitle");if(o&&n&&s){t.classList.remove("hidden");if(e.success&&!e.error)o.textContent="小报生成成功！",n.src=e.imageUrl,n.onerror=function(){console.error("图片加载失败:",e.imageUrl),this.src="images/error-placeholder.svg",o&&(o.textContent="图片加载失败")}.bind(n),n.onload=function(){console.log("图片加载成功:",e.imageUrl)}.bind(n),r&&(r.textContent="生成完成！"),a&&(a.textContent="你的英语小报已经创建成功");else{let o=e.error;(!o||o.includes("access permissions")||o.includes("Network")||o.includes("timeout")||!1===o.includes("API"))&&(o=this.getFriendlyErrorMessage(o)),t.classList.add("hidden"),n.src="images/error-placeholder.svg",r&&(r.textContent="生成失败！"),a&&(a.textContent=o)}const i=e.vocabulary.map(e=>`\n                <div class="result-word">\n                    <div class="result-word-english">${e.english}</div>\n                    <div class="result-word-phonetic">/${e.phonetic}/</div>\n                    <div class="result-word-chinese">${e.chinese}</div>\n                </div>\n            `).join("");s.innerHTML=i}this.bindResultPageButtons(e)}bindResultPageButtons(e){const t=document.getElementById("createNewBtn");t&&t.addEventListener("click",async()=>{this.resetForNewCreation(),document.body.classList.remove("result-visible"),await this.showSection("welcomeSection")});const o=document.getElementById("regenerateBtn");o&&o.addEventListener("click",()=>{this.handleGeneration()})}async handleGeneration(){var o,n,s;if(console.log("handleGeneration called"),console.log("API Key:",this.store.state.apiKey?"exists":"missing"),console.log("Selected vocabulary count:",this.store.state.selectedVocabulary.length),!this.store.state.apiKey)return this.showToast("请先在设置中配置API密钥"),void this.showModal("settingsModal");if(0!==this.store.state.selectedVocabulary.length)try{const a=new e(this.store.state.apiKey),i=new t,l=await i.generatePrompt({theme:this.store.state.currentTheme,scene:this.store.state.currentScene,vocabulary:this.store.state.selectedVocabulary,customTitle:this.store.state.customTitle});let c;this.store.setState({generationStatus:"generating",generationProgress:0}),this.showModal("generationModal"),console.log("开始生成流程 - 阶段1：准备和提交"),this.lastProgress=0,this.updateProgress(10,"准备提示词..."),await this.delay(500),this.updateProgress(30,"提交生成任务..."),await this.delay(500),console.log("进入AI绘画阶段");let d=30;try{const e=a.generate(l,{aspectRatio:(null==(o=document.getElementById("aspectRatio"))?void 0:o.value)||"3:4",resolution:(null==(n=document.getElementById("resolution"))?void 0:n.value)||"2K",outputFormat:(null==(s=document.getElementById("outputFormat"))?void 0:s.value)||"png",timeout:12e4,onProgress:(e,t)=>{console.log(`[API] Progress callback: ${e}% - ${t||"AI绘画中..."}`),this.updateProgress(e,t||"AI绘画中..."),d=e}});this.simulateSlowProgress(30,90,6e4),c=await e,console.log("API调用成功:",c),this.stopSlowProgress(),d<90&&(this.updateProgress(90,"优化细节..."),await this.delay(200))}catch(r){console.error("API调用失败:",r),this.stopSlowProgress(),c={success:!1,error:r.message||"API调用失败"},d<90&&(this.updateProgress(90,"生成失败，准备返回结果..."),await this.delay(300))}if(console.log("进入收尾阶段"),this.updateProgress(95,"渲染图像..."),await this.delay(300),this.updateProgress(100,"生成完成！"),await this.delay(500),c.success){this.store.setState({generationStatus:"success",generationProgress:100});const e=document.getElementById("modalProgressFill"),t=document.getElementById("modalProgressDesc"),o=document.getElementById("modalProgressPercent");e&&(e.style.width="100%"),t&&(t.textContent="生成完成！"),o&&(o.textContent="100%"),setTimeout(async()=>{this.hideModal("generationModal"),await this.showResult({success:!0,imageUrl:c.imageUrl,vocabulary:this.store.state.selectedVocabulary}),window.scrollTo({top:0,behavior:"smooth"})},1e3)}else{this.store.setState({generationStatus:"error"});const e=document.getElementById("modalProgressDesc");e&&(e.textContent="生成失败"),setTimeout(async()=>{this.hideModal("generationModal"),await this.showResult({success:!1,error:c.error,vocabulary:this.store.state.selectedVocabulary}),window.scrollTo({top:0,behavior:"smooth"})},1e3)}}catch(r){console.error("生成过程中发生异常:",r),console.error("错误堆栈:",r.stack),this.stopSlowProgress(),this.store.setState({generationStatus:"error"});const e=document.getElementById("modalProgressDesc");e&&(e.textContent="生成失败"),setTimeout(async()=>{const e=document.getElementById("generationModal");e&&(e.classList.add("hidden"),document.body.classList.remove("modal-open"));const t=this.getFriendlyErrorMessage(r.message);await this.showResult({success:!1,error:t,vocabulary:this.store.state.selectedVocabulary}),window.scrollTo({top:0,behavior:"smooth"})},1e3)}else this.showToast("请至少选择一个词汇")}getFriendlyErrorMessage(e){return e.includes("access permissions")||e.includes("AUTHENTICATION_FAILED")?"API密钥错误或无效，请检查设置中的API密钥":e.includes("网络错误")||e.includes("Network")?"网络连接失败，请检查网络设置后重试":e.includes("超时")||e.includes("timeout")?"生成超时，请稍后重试":e||"小报生成失败，请稍后重试"}resetForNewCreation(){console.log("resetForNewCreation called"),this.store.setState({generationStatus:"idle",generationProgress:0,currentWork:null,currentTheme:null,currentScene:null,selectedVocabulary:[]});const e=document.getElementById("customTitle");e&&(e.value="",this.store.setState({customTitle:""}))}updateProgress(e,t){var o;if((e=Math.round(e))<this.lastProgress)return void console.log(`[PROGRESS] Ignoring backward progress: ${e}% < ${this.lastProgress}%`);this.lastProgress=e,console.log(`[PROGRESS] ${e}% - ${t} - 来源: ${(null==(o=(new Error).stack.split("\n")[2])?void 0:o.trim())||"unknown"}`),this.store.setState({generationProgress:e});const n=document.getElementById("modalProgressFill"),s=document.getElementById("modalProgressDesc"),r=document.getElementById("modalProgressPercent");n&&(n.style.width=`${e}%`),s&&(s.textContent=t),r&&(r.textContent=`${e}%`);const a=document.querySelectorAll("#modalProgressSteps .step"),i=Math.floor(e/20);a.forEach((e,t)=>{t<=i?e.classList.add("active"):e.classList.remove("active")})}delay(e){return new Promise(t=>setTimeout(t,e))}simulateSlowProgress(e,t,o){const n=Date.now(),s=t-e;let r=e;this.progressInterval&&clearInterval(this.progressInterval),this.progressInterval=setInterval(()=>{const a=Date.now()-n,i=Math.min(e+s*a/o,t);if(i>r){r=i;const e=Math.floor(i);console.log(`[SIMULATE] Updating progress from simulateSlowProgress: ${e}% (raw: ${i}%)`),this.updateProgress(e,"AI绘画中...")}(i>=t||a>=o)&&(clearInterval(this.progressInterval),this.progressInterval=null)},1e3)}stopSlowProgress(){this.progressInterval&&(clearInterval(this.progressInterval),this.progressInterval=null)}}async function r(){const e=document.getElementById("themeGrid");if(e)try{e.innerHTML='<div class="loading-themes">正在加载主题数据...</div>';const t=await fetch("themes.json");if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);const o=(await t.json()).themes;if(!o||!Array.isArray(o))throw new Error("主题数据格式错误");window.themes=o,console.log("主题数据加载成功:",o.length,"个主题");const n=o.map(e=>`\n            <div class="theme-card" data-theme-id="${e.id}">\n                <div class="theme-icon">${e.icon}</div>\n                <h3>${e.name}</h3>\n                <p>${e.description}</p>\n                <div class="theme-scenes">\n                    ${e.scenes?e.scenes.map(e=>`\n                        <span class="scene-tag">${e.name}</span>\n                    `).join(""):""}\n                </div>\n            </div>\n        `).join("");e.innerHTML=n}catch(t){console.error("加载主题数据失败:",t),e.innerHTML=`\n            <div class="error-message">\n                <p>加载主题数据失败</p>\n                <p>${t.message}</p>\n                <button onclick="renderThemes()" class="modern-btn btn-primary">重试</button>\n            </div>\n        `}}class a{constructor(){this.store=new o,this.uiController=null,this.init()}async init(){try{this.hideAllModalsOnStartup();const e=await fetch("themes.json"),t=await e.json();window.themes=t.themes,this.uiController=new s(this.store),await r(),this.store.subscribe(e=>{this.uiController&&this.uiController.vocabularyEditor&&this.uiController.vocabularyEditor.updateUI()}),console.log("应用初始化成功")}catch(e){console.error("应用初始化失败:",e),this.showToast("应用初始化失败，请刷新页面重试")}}hideAllModalsOnStartup(){document.querySelectorAll('.modal-overlay, [id$="Modal"]').forEach(e=>{e.classList.add("hidden"),e.style.display="",e.style.visibility="",e.style.opacity="",e.style.zIndex=""}),console.log("所有模态框已在启动时隐藏")}}window.selectAllVocabulary=function(){window.app&&window.app.store&&(window.app.store.selectAllVocabulary(),window.app.uiController.showToast(`已选择 ${window.app.store.state.selectedVocabulary.length} 个词汇`))},window.clearAllVocabulary=function(){window.app&&window.app.store&&(window.app.store.clearAllVocabulary(),window.app.uiController.showToast("已清空所有选择"))},window.addEventListener("DOMContentLoaded",()=>{window.app=new a}),function(){let e=!1;function t(){if(e)return void console.log("词汇功能正在初始化中，跳过重复调用");e=!0,console.log("DOM已加载，开始初始化词汇功能");let r=document.querySelector(".vocabulary-categories"),a=r?r.parentElement:null;if(!r&&!a){console.log("未找到词汇容器，尝试查找词汇列表...");const e=document.getElementById("vocabularyList");e&&(a=e,console.log("找到词汇列表容器"))}if(!r&&!a)return console.log("仍未找到词汇容器，等待2秒后重试..."),e=!1,void setTimeout(t,2e3);const i=r||a;if(console.log("找到目标容器，应用修复"),"true"===i.getAttribute("data-vocabulary-fixed"))return console.log("容器已修复，跳过重复修复"),void(e=!1);i.removeEventListener("click",o),i.addEventListener("click",o,!0),i.setAttribute("data-vocabulary-fixed","true"),setTimeout(()=>{!function(){const e=document.querySelectorAll(".word-item");console.log("更新所有词汇项，数量:",e.length),e.forEach(e=>{n(e)}),s(),function(){var e;const t=document.querySelector(".config-card:has(.vocabulary-categories)");if(t){const o=t.querySelector(".vocabulary-categories");if(o){const n=window.getComputedStyle(t),s=t.offsetHeight-parseInt(n.paddingTop)-parseInt(n.paddingBottom)-((null==(e=t.querySelector(".vocabulary-controls"))?void 0:e.offsetHeight)||80)-20;o.style.maxHeight=`${Math.min(s,280)}px`}}}()}(),e=!1},100)}function o(e){const t=e.target.closest(".word-item"),o=e.target.closest(".toggle-btn");if(t||o){console.log("检测到词汇点击"),e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation();const r=t||o.closest(".word-item");r&&function(e){var t,o,r;console.log("切换词汇选择状态");const a={english:e.dataset.word,phonetic:(null==(o=null==(t=e.querySelector(".word-phonetic"))?void 0:t.textContent)?void 0:o.replace(/[\/\\]/g,""))||"",chinese:(null==(r=e.querySelector(".word-chinese"))?void 0:r.textContent)||"",category:e.dataset.category||"object"};if(console.log("处理词汇:",a),window.app&&window.app.store){const t=window.app.store.state.selectedVocabulary,o=t.some(e=>e.english===a.english);if(console.log("当前选中状态:",o),o){const e=t.filter(e=>e.english!==a.english);window.app.store.setState({selectedVocabulary:e}),console.log("已取消选择")}else{if(!(t.length<20))return void alert("最多只能选择20个词汇");{const e=[...t,a];window.app.store.setState({selectedVocabulary:e}),console.log("已添加选择")}}n(e),s()}else{console.log("使用后备方案");if(e.classList.contains("selected")){e.classList.remove("selected");const t=e.querySelector(".toggle-btn");t&&(t.textContent="+")}else{if(document.querySelectorAll(".word-item.selected").length>=20)return void alert("最多只能选择20个词汇");e.classList.add("selected");const t=e.querySelector(".toggle-btn");t&&(t.textContent="✓")}s()}e.style.transform="scale(0.95)",setTimeout(()=>{e.style.transform=""},150)}(r)}}function n(e){const t=e.dataset.word;if(window.app&&window.app.store){const o=window.app.store.state.selectedVocabulary.some(e=>e.english===t),n=e.querySelector(".toggle-btn");o?(e.classList.add("selected"),n&&(n.textContent="✓")):(e.classList.remove("selected"),n&&(n.textContent="+"))}}function s(){const e=document.getElementById("selectedCount");if(!e)return;let t=0;t=window.app&&window.app.store?window.app.store.state.selectedVocabulary.length:document.querySelectorAll(".word-item.selected").length,e.textContent=t,console.log("更新词汇计数:",t)}function r(){const e=document.getElementById("selectAllBtn"),t=document.getElementById("clearAllBtn");e&&(console.log("重新绑定全选按钮"),e.onclick=function(e){e.preventDefault(),e.stopPropagation(),window.fixSelectAll()}),t&&(console.log("重新绑定清空按钮"),t.onclick=function(e){e.preventDefault(),e.stopPropagation(),window.fixClearAll()})}window.fixSelectAll=function(){console.log("执行全选修复");const e=document.querySelectorAll(".word-item"),t=[];e.forEach((e,o)=>{var n,s,r;if(o<20){const o={english:e.dataset.word,phonetic:(null==(s=null==(n=e.querySelector(".word-phonetic"))?void 0:n.textContent)?void 0:s.replace(/[\/\\]/g,""))||"",chinese:(null==(r=e.querySelector(".word-chinese"))?void 0:r.textContent)||"",category:e.dataset.category||"object"};t.push(o),e.classList.add("selected");const a=e.querySelector(".toggle-btn");a&&(a.textContent="✓")}}),window.app&&window.app.store&&window.app.store.setState({selectedVocabulary:t}),s(),window.app&&window.app.uiController?window.app.uiController.showToast(`已选择 ${t.length} 个词汇`):console.log(`已选择 ${t.length} 个词汇`)},window.fixClearAll=function(){console.log("执行清空修复");document.querySelectorAll(".word-item").forEach(e=>{e.classList.remove("selected");const t=e.querySelector(".toggle-btn");t&&(t.textContent="+")}),window.app&&window.app.store&&(window.app.store.setState({selectedVocabulary:[]}),window.app.uiController.showToast("已清空所有选择")),s()},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t):t(),r(),function(){let e=!1;const o=new MutationObserver(o=>{if(e)return;let n=!1;o.forEach(e=>{"childList"===e.type&&(e.addedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&(e.classList&&e.classList.contains("word-item")||e.querySelector&&e.querySelector(".word-item"))&&(n=!0)}),e.removedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&e.classList&&e.classList.contains("word-item")&&(n=!0)}))}),n&&(e=!0,console.log("检测到词汇元素变化，重新绑定事件"),setTimeout(()=>{t(),r(),e=!1},200))});o.observe(document.body,{childList:!0,subtree:!0})}(),function(){let e=0;const t=setInterval(()=>{e++;const n=document.querySelectorAll('.vocabulary-categories:not([data-vocabulary-fixed="true"])'),s=document.querySelector(".word-item");n.length>0&&s&&(console.log("发现未修复的词汇容器，进行修复"),document.querySelectorAll('.vocabulary-categories:not([data-vocabulary-fixed="true"])').forEach(e=>{e.removeEventListener("click",o),e.addEventListener("click",o,!0),e.setAttribute("data-vocabulary-fixed","true"),console.log("已修复并标记词汇容器")}),r()),(0===n.length||s||e>=5)&&(clearInterval(t),console.log("智能轮询结束，检查次数:",e))},2e3)}(),console.log("词汇选择修复已应用")}();class i{constructor(){var e;this.tutorialStep=1,this.maxTutorialSteps=4,this.showTutorial=!1,this.store=null==(e=window.app)?void 0:e.store,this.lastSection=null,this.init()}init(){this.setupTutorialModal(),this.setupStylePicker(),this.setupSettingsHandler(),this.checkFirstVisit(),this.store&&(this.store.subscribe(e=>{this.lastSection!==e.currentSection&&(console.log("Section changed:",e.currentSection),this.lastSection=e.currentSection)}),this.lastSection=this.store.state.currentSection)}checkFirstVisit(){const e=localStorage.getItem("selectedThemeStyle");e&&this.applyThemeStyle(e)}setupTutorialModal(){const e=document.getElementById("tutorialModal"),t=document.getElementById("prevTutorialBtn"),o=document.getElementById("nextTutorialBtn"),n=document.getElementById("skipTutorialBtn");e&&(this.updateTutorialStep=()=>{const n=e.querySelectorAll(".tutorial-step"),s=e.querySelectorAll(".dot");n.forEach((e,t)=>{e.classList.toggle("active",t+1===this.tutorialStep)}),s.forEach((e,t)=>{e.classList.toggle("active",t+1===this.tutorialStep)}),t.disabled=1===this.tutorialStep,o.textContent=this.tutorialStep===this.maxTutorialSteps?"开始使用":"下一步";const r=e.querySelector(".progress-fill"),a=this.tutorialStep/this.maxTutorialSteps*100;r.style.width=`${a}%`},o&&o.addEventListener("click",()=>{this.tutorialStep<this.maxTutorialSteps?(this.tutorialStep++,this.updateTutorialStep()):(this.hideTutorialModal(),localStorage.setItem("hasVisited","true"))}),t&&t.addEventListener("click",()=>{this.tutorialStep>1&&(this.tutorialStep--,this.updateTutorialStep())}),n&&n.addEventListener("click",()=>{this.hideTutorialModal(),localStorage.setItem("hasVisited","true")}))}showTutorialModal(){const e=document.getElementById("tutorialModal");e&&(this.tutorialStep=1,this.updateTutorialStep(),e.classList.remove("hidden"),e.style.display="flex",e.classList.add("show"))}hideTutorialModal(){const e=document.getElementById("tutorialModal");e&&(e.classList.remove("show"),e.classList.add("hide"),setTimeout(()=>{e.classList.add("hidden"),e.style.display="none",e.classList.remove("hide"),document.body.style.overflow=""},300))}setupStylePicker(){const e=document.getElementById("themeStyleOverlay");if(document.getElementById("themeStyleBtn"),!e)return;const t=e.querySelectorAll(".style-option"),o=document.getElementById("confirmStylePicker"),n=document.getElementById("cancelStylePicker");t.forEach(e=>{e.addEventListener("click",()=>{t.forEach(e=>e.classList.remove("selected")),e.classList.add("selected")})}),o&&o.addEventListener("click",()=>{const t=e.querySelector(".style-option.selected");if(t){const e=t.dataset.style;this.applyThemeStyle(e),localStorage.setItem("selectedThemeStyle",e),this.hideStylePicker()}}),n&&n.addEventListener("click",()=>{this.hideStylePicker()}),e.addEventListener("click",t=>{t.target===e&&this.hideStylePicker()})}showStylePicker(e){window.app&&window.app.uiController&&window.app.uiController.showModal("themeStyleOverlay");const t=document.getElementById("themeStyleOverlay");if(t){const e=localStorage.getItem("selectedThemeStyle")||"default";t.querySelectorAll(".style-option").forEach(t=>{t.classList.toggle("selected",t.dataset.style===e)})}}hideStylePicker(){window.app&&window.app.uiController&&window.app.uiController.hideModal("themeStyleOverlay")}applyThemeStyle(e){document.querySelectorAll("style[data-theme]").forEach(e=>e.remove());const t={default:"\n                :root {\n                  --primary: #667eea;\n                  --secondary: #764ba2;\n                  --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);\n                }\n                .icon-btn {\n                  background: rgba(255, 255, 255, 0.9);\n                  color: #333;\n                  border-radius: 20px;\n                }\n                .icon-btn:hover {\n                  background: white;\n                  color: #667eea;\n                }\n            ",dark:"\n                :root {\n                  --primary: #1a202c;\n                  --secondary: #2d3748;\n                  --gradient-primary: linear-gradient(135deg, #1a202c 0%, #2d3748 50%, #4a5568 100%);\n                  --bg-primary: #1a202c;\n                  --text-primary: #f7fafc;\n                  --text-secondary: #e2e8f0;\n                }\n                body {\n                  background: #0f1419;\n                  color: #f7fafc;\n                }\n                .icon-btn {\n                  background: rgba(30, 30, 30, 0.9);\n                  color: #f7fafc;\n                  border-radius: 20px;\n                }\n                .icon-btn:hover {\n                  background: rgba(26, 32, 44, 0.9);\n                  color: #00ffff;\n                }\n            ",cyber:"\n                :root {\n                  --primary: #00ffff;\n                  --secondary: #ff00ff;\n                  --gradient-primary: linear-gradient(135deg, #00ffff 0%, #ff00ff 50%, #ffff00 100%);\n                }\n                body {\n                  background: #0a0a0a;\n                  color: #00ffff;\n                }\n                .icon-btn {\n                  background: rgba(0, 255, 255, 0.1);\n                  border: 1px solid rgba(0, 255, 255, 0.3);\n                  color: #00ffff;\n                  border-radius: 20px;\n                }\n                .icon-btn:hover {\n                  background: rgba(0, 255, 255, 0.2);\n                  border-color: #00ffff;\n                  color: #ffffff;\n                  box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);\n                }\n            ",macaron:"\n                :root {\n                  --primary: #FF6B9D;\n                  --secondary: #4ECDC4;\n                  --gradient-primary: linear-gradient(135deg, #FF6B9D 0%, #4ECDC4 50%, #FFE66D 100%);\n                }\n                body {\n                  background: linear-gradient(135deg, #B3E5FF 0%, #FFB3D1 50%, #B3FFD9 100%);\n                }\n                .icon-btn {\n                  background: rgba(255, 255, 255, 0.8);\n                  border: 2px solid #FF6B9D;\n                  color: #FF6B9D;\n                  border-radius: 20px;\n                }\n                .icon-btn:hover {\n                  background: #FF6B9D;\n                  color: white;\n                  transform: scale(1.05);\n                }\n            ",apple:"\n                :root {\n                  --primary: #007AFF;\n                  --secondary: #5856D6;\n                  --gradient-primary: linear-gradient(135deg, #007AFF 0%, #5856D6 50%, #FF2D92 100%);\n                }\n                body {\n                  background: #f2f2f7;\n                  color: #1d1d1f;\n                }\n                .icon-btn {\n                  background: rgba(255, 255, 255, 0.9);\n                  border: 1px solid rgba(0, 122, 255, 0.2);\n                  color: #007AFF;\n                  border-radius: 20px;\n                }\n                .icon-btn:hover {\n                  background: #007AFF;\n                  color: white;\n                  box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);\n                }\n            ",ocean:"\n                :root {\n                  --primary: #0077be;\n                  --secondary: #00a8cc;\n                  --gradient-primary: linear-gradient(135deg, #0077be 0%, #00a8cc 50%, #00d4ff 100%);\n                }\n                body {\n                  background: linear-gradient(135deg, #0077be 0%, #00a8cc 50%, #00d4ff 100%);\n                }\n                .icon-btn {\n                  background: rgba(255, 255, 255, 0.9);\n                  border: 1px solid rgba(0, 119, 190, 0.3);\n                  color: #0077be;\n                  border-radius: 20px;\n                }\n                .icon-btn:hover {\n                  background: rgba(0, 119, 190, 0.9);\n                  color: white;\n                  box-shadow: 0 4px 12px rgba(0, 119, 190, 0.4);\n                }\n            "};if(t[e]){const o=document.createElement("style");o.setAttribute("data-theme",e),o.textContent=t[e],document.head.appendChild(o)}}setupSettingsHandler(){document.getElementById("settingsBtn");const e=document.getElementById("themeStyleBtn");document.getElementById("galleryBtn"),e&&e.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.showStylePicker(e)}),setTimeout(()=>{const e=localStorage.getItem("selectedThemeStyle");e&&this.applyThemeStyle(e)},200);const t=document.getElementById("settingsModal");t&&t.addEventListener("click",e=>{e.target===t&&(e.preventDefault(),e.stopPropagation(),this.hideSettingsModal())});const o=document.getElementById("saveSettingsBtn"),n=document.getElementById("cancelSettingsBtn"),s=document.getElementById("closeSettingsBtn"),r=document.getElementById("toggleApiKeyVisibility");r&&r.addEventListener("click",()=>{this.toggleApiKeyVisibility()}),o&&o.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.saveSettings()}),n&&n.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.hideSettingsModal()}),s&&s.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.hideSettingsModal()});const a=document.getElementById("galleryModal");a&&a.addEventListener("click",e=>{e.target===a&&(e.preventDefault(),e.stopPropagation(),this.hideGalleryModal())});const i=document.getElementById("closeGalleryBtn"),l=document.getElementById("closeGalleryBtn2"),c=document.getElementById("clearGalleryBtn");[i,l].forEach(e=>{e&&e.addEventListener("click",()=>this.hideGalleryModal())}),c&&c.addEventListener("click",()=>{confirm("确定要清空作品库吗？此操作不可恢复。")&&window.app&&window.app.store&&(window.app.store.clearGallery(),this.showToast("作品库已清空"))})}showGalleryModal(){window.app&&window.app.uiController&&window.app.uiController.showModal("galleryModal")}hideGalleryModal(){window.app&&window.app.uiController&&window.app.uiController.hideModal("galleryModal")}showSettingsModal(){this.loadSettings(),window.app&&window.app.uiController&&window.app.uiController.showModal("settingsModal")}hideSettingsModal(){const e=document.getElementById("apiKey"),t=document.getElementById("toggleApiKeyVisibility");e&&t&&(e.type="password",t.classList.remove("show-api-key"),t.title="显示密钥",localStorage.setItem("apiKeyVisible","false")),window.app&&window.app.uiController&&window.app.uiController.hideModal("settingsModal")}loadSettings(){const e=document.getElementById("showTutorial");e&&(e.checked="false"!==localStorage.getItem("showTutorial"));const t=document.getElementById("apiKey"),o=document.getElementById("toggleApiKeyVisibility");t&&o&&(t.type="password",o.classList.remove("show-api-key"),o.title="显示密钥")}saveSettings(){if(window.modernUI&&window.modernUI.saveSettings)window.modernUI.saveSettings(!0),this.hideSettingsModal();else{const t=document.getElementById("apiKey");if(t){const o=t.value.trim();if(o){localStorage.setItem("apiKey",o);try{const e=localStorage.getItem("bulletin-store"),t=e?JSON.parse(e):{settings:{}};t.settings.apiKey=o,localStorage.setItem("bulletin-store",JSON.stringify(t))}catch(e){console.error("保存 API key 到 bulletin-store 失败:",e)}}else{localStorage.removeItem("apiKey");try{const e=localStorage.getItem("bulletin-store");if(e){const t=JSON.parse(e);t.settings&&(delete t.settings.apiKey,localStorage.setItem("bulletin-store",JSON.stringify(t)))}}catch(e){console.error("从 bulletin-store 删除 API key 失败:",e)}}}this.hideSettingsModal(),this.showToast("设置已保存")}}showToast(e,t=3e3){const o=document.createElement("div");o.className="toast",o.textContent=e,o.style.cssText="\n            position: fixed;\n            bottom: 20px;\n            left: 50%;\n            transform: translateX(-50%);\n            background: rgba(0, 0, 0, 0.8);\n            color: white;\n            padding: 12px 24px;\n            border-radius: 20px;\n            font-size: 14px;\n            z-index: 9999;\n            animation: slideInUp 0.3s ease-out;\n        ",document.body.appendChild(o),setTimeout(()=>{o.remove()},t)}toggleApiKeyVisibility(){const e=document.getElementById("apiKey"),t=document.getElementById("toggleApiKeyVisibility");e&&t&&("password"===e.type?(e.type="text",t.classList.add("show-api-key"),t.title="隐藏密钥"):(e.type="password",t.classList.remove("show-api-key"),t.title="显示密钥"))}}const l=document.createElement("style");l.textContent="\n    @keyframes pulse {\n        0% { transform: scale(1); }\n        50% { transform: scale(1.1); }\n        100% { transform: scale(1); }\n    }\n\n    @keyframes slideInUp {\n        from {\n            opacity: 0;\n            transform: translateY(30px) scale(0.9);\n        }\n        to {\n            opacity: 1;\n            transform: translateY(0) scale(1);\n        }\n    }\n\n    /* 模态框过渡动画 */\n    .modal-overlay.show {\n        animation: slideInUp 0.3s ease-out;\n    }\n\n    .modal-overlay.hide {\n        animation: slideInUp 0.3s ease-out reverse;\n    }\n\n    /* SVG图标动画 */\n    .header-actions .icon-btn {\n        position: relative;\n        overflow: visible;\n        padding: 4px !important;\n        min-width: 36px;\n        min-height: 36px;\n    }\n\n    .header-actions .icon-btn svg {\n        transition: all 0.3s ease;\n        transform-origin: center;\n        width: 20px !important;\n        height: 20px !important;\n    }\n\n    .header-actions .icon-btn:hover svg {\n        transform: rotate(15deg) scale(1.1);\n    }\n\n    /* 设置按钮齿轮动画 */\n    .header-actions #settingsBtn svg .gear-teeth {\n        animation: rotate 3s linear infinite;\n        transform-origin: center;\n    }\n\n    /* 主题按钮光晕动画 */\n    .header-actions #themeStyleBtn svg .sun-rays {\n        animation: pulse 2s ease-in-out infinite;\n    }\n\n    /* 作品库按钮图片动画 */\n    .header-actions #galleryBtn svg .photo-frame {\n        transition: all 0.3s ease;\n    }\n\n    .header-actions #galleryBtn:hover svg .photo-frame {\n        transform: scale(1.05);\n    }\n\n    .header-actions #galleryBtn svg .photo-dot {\n        animation: float 3s ease-in-out infinite;\n    }\n\n    @keyframes rotate {\n        from { transform: rotate(0deg); }\n        to { transform: rotate(360deg); }\n    }\n\n    @keyframes pulse {\n        0%, 100% { opacity: 1; }\n        50% { opacity: 0.6; }\n    }\n\n    @keyframes float {\n        0%, 100% { transform: translateY(0); }\n        50% { transform: translateY(-3px); }\n    }\n",document.head.appendChild(l),window.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>{window.enhancedFeatures=new i,console.log("Enhanced features initialized")},100)});
